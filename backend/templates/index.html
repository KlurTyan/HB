<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System 20.0 - Birthday Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fira Code', monospace;
            background-color: #0a0a0a;
            color: #22c55e;
            overscroll-behavior: none;
        }
        .terminal-glow { box-shadow: 0 0 20px rgba(34, 197, 94, 0.15); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .task-card { transition: all 0.3s ease; }
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(34, 197, 94, 0.1);
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 50;
        }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col">
    <div class="scanline"></div>

    <div id="admin-panel" class="hidden border-2 border-purple-500 p-4 rounded-lg mb-6 bg-purple-900/10 shadow-[0_0_20px_rgba(168,85,247,0.2)]">
        <div class="text-[10px] text-purple-400 font-bold mb-2 blink">‚óè SYSTEM_ADMIN_ACCESS_GRANTED</div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="adminApi('/api/admin/poll/start')" class="bg-purple-600 text-white py-2 rounded font-bold text-xs hover:bg-purple-500 transition-colors shadow-lg shadow-purple-900/50">
                START POLL
            </button>
            <button onclick="adminApi('/api/admin/poll/stop')" class="bg-black border border-purple-500 text-purple-400 py-2 rounded font-bold text-xs hover:bg-purple-900/30 transition-colors">
                STOP & LOG
            </button>
        </div>
    </div>


    <header class="border-b border-green-900 pb-2 mb-4 flex justify-between items-center text-[10px] tracking-tighter">
        <div>CORE_V: 2.0.0</div>
        <div class="flex items-center">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
            STATUS: RUNNING
        </div>
        <div id="user-name-display">#GUEST</div>
    </header>

    <div class="border border-green-500 p-4 rounded-lg mb-4 terminal-glow bg-black/50 relative overflow-hidden">
        <div class="text-[10px] opacity-50 uppercase mb-1">Active Module:</div>
        <h1 class="text-xl font-bold uppercase tracking-widest border-b border-green-900 pb-2 flex justify-between">
            <span>> <span id="role-name">LOADING...</span></span>
        </h1>

        <div id="tasks-container" class="mt-4 space-y-4 text-white">
            <div class="text-center py-4 opacity-50 text-xs">Initializing task modules...</div>
        </div>

        <div id="secret-code-zone" class="hidden mt-6 p-4 bg-green-900/20 border border-dashed border-green-500 text-center rounded-lg">
            <span class="text-[10px] block text-green-300 mb-1 font-bold font-white">ACCESS GRANTED. SECRET_KEY:</span>
            <span class="text-3xl font-bold tracking-[0.5em] ml-[0.5em] text-white" id="secret-char">?</span>
        </div>
    </div>

    <div class="flex-grow overflow-hidden flex flex-col border border-green-900 rounded bg-black/40 p-2 mb-4 shadow-inner">
        <div class="text-[9px] uppercase mb-1 opacity-40 flex justify-between">
            <span>System Logs</span>
            <span id="socket-status">connecting...</span>
        </div>
        <div id="logs" class="text-[11px] space-y-1 overflow-y-auto scroll-hide flex flex-col-reverse">
            </div>
    </div>

    <div id="poll-container" class="hidden grid grid-cols-2 gap-3 mb-2">
        <button onclick="sendReaction('fire')" class="bg-orange-900/20 border border-orange-500 text-orange-500 py-4 rounded-lg active:bg-orange-900/50 transition-all font-bold text-sm shadow-[0_0_10px_rgba(249,115,22,0.3)]">
            üî• –û–ì–û–ù–¨
        </button>
        <button onclick="sendReaction('cringe')" class="bg-blue-900/20 border border-blue-500 text-blue-500 py-4 rounded-lg active:bg-blue-900/50 transition-all font-bold text-sm shadow-[0_0_10px_rgba(59,130,246,0.3)]">
            üé§ –ö–†–ò–ù–ñ
        </button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const pollContainer = document.getElementById('poll-container');

        // WebSocket Setup
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${protocol}//${window.location.host}/ws/logs`);

        socket.onopen = () => {
            document.getElementById('socket-status').innerText = 'online';
            addLogMessage("–°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ —è–¥—Ä—É.");
        };
        socket.onclose = () => document.getElementById('socket-status').innerText = 'offline';

        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'start_poll') {
                    pollContainer.classList.remove('hidden');
                    addLogMessage("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–ø—É—â–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ!");
                }
                else if (data.type === 'stop_poll') {
                    pollContainer.classList.add('hidden');
                    addLogMessage(data.message || "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
                }
                else {
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å message
                    addLogMessage(data.message || data);
                }
            } catch (e) {
                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞ (–Ω–µ JSON)
                addLogMessage(event.data);
            }
        };

        function addLogMessage(msg) {
            const logsDiv = document.getElementById('logs');
            const newLog = document.createElement('div');
            const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            newLog.innerHTML = `<span class="opacity-30">[${time}]</span> ${msg}`;
            logsDiv.prepend(newLog);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (logsDiv.children.length > 30) logsDiv.removeChild(logsDiv.lastChild);
        }

        // API Functions
        async function loadProfile() {

            if (!token) {
                document.getElementById('role-name').innerText = "ERROR: NO TOKEN";
                return;
            }
            try {
                const response = await fetch(`/api/profile/${token}`);
                if (!response.ok) throw new Error("Profile not found");
                const data = await response.json();

                if (token === "admin") {
                    document.getElementById('admin-panel').classList.remove('hidden');
    }

                document.getElementById('role-name').innerText = data.role;
                document.getElementById('user-name-display').innerText = `#${data.name.toUpperCase()}`;

                const container = document.getElementById('tasks-container');
                container.innerHTML = '';

                data.tasks.forEach(task => {
                    const isDone = task.is_completed;
                    const taskHtml = `
                        <div class="task-card border ${isDone ? 'border-green-900 bg-green-900/5 opacity-60' : 'border-green-700 bg-black/40'} p-3 rounded-md relative transition-all">
                            <div class="flex justify-between items-center mb-1 text-[10px]">
                                <span class="font-bold uppercase ${isDone ? 'text-green-900' : 'text-green-400'}">
                                    ${isDone ? '‚óè Module_Sync' : '‚óã Task_Active'}
                                </span>
                                <span class="px-1 rounded ${isDone ? 'bg-green-900 text-green-300' : 'bg-red-900/50 text-red-400 animate-pulse'}">
                                    ${isDone ? 'COMPLETED' : 'PENDING'}
                                </span>
                            </div>
                            <h3 class="text-sm font-bold ${isDone ? 'text-green-800' : 'text-white'}">${task.title}</h3>
                            <p class="text-[11px] mt-1 text-green-500/60 leading-tight">${task.description}</p>
                            ${!isDone ? `
                                <button onclick="completeTask(${task.id})" class="mt-3 w-full border border-green-500 py-2 text-[10px] font-bold hover:bg-green-500 hover:text-black transition-all uppercase tracking-widest bg-green-500/5">
                                    –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –í–´–ü–û–õ–ù–ï–ù–ò–ï
                                </button>
                            ` : ''}
                        </div>
                    `;


                    if (data.poll_active === true) {
                        pollContainer.classList.remove('hidden');
                    } else {
                        pollContainer.classList.add('hidden');
                    }
                    container.innerHTML += taskHtml;
                });


                const allDone = data.tasks.length > 0 && data.tasks.every(t => t.is_completed);
                if (allDone) {
                    document.getElementById('secret-char').innerText = data.secret_char;
                    document.getElementById('secret-code-zone').classList.remove('hidden');
                }
            } catch (error) {
                console.error(error);
                addLogMessage("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è.");
            }
        }

        async function completeTask(taskId) {
            if(!confirm("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª—è?")) return;
            try {
                const response = await fetch(`/api/complete-task/?task_id=${taskId}&token=${token}`, { method: 'POST' });
                if (response.ok) {
                    await loadProfile();
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è");
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            }
        }

        async function sendReaction(type) {
            pollContainer.classList.add('hidden');
            try {
                fetch(`/api/react`, {
                    method: 'POST',
                    body: JSON.stringify({ token: token, type: type }),
                    headers: { 'Content-Type': 'application/json' }
                });
            }
            finally {
                setTimeout(() => {
                    pollContainer.style.opacity = '1';
                    pollContainer.style.pointerEvents = 'auto';
                });
            }
        }

        async function adminApi(path) {
            try {
                const response = await fetch(path, {
                    method: 'POST',
                    // –ï—Å–ª–∏ —Ç—ã –¥–æ–±–∞–≤–∏–ª –∑–∞—â–∏—Ç—É –Ω–∞ –±—ç–∫–µ–Ω–¥, –ø–µ—Ä–µ–¥–∞–≤–∞–π —Ç–æ–∫–µ–Ω –∏ —Ç—É—Ç
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    console.log(response)
                }
            } catch (e) {
                addLogMessage("–û—à–∏–±–∫–∞: " + e.message);
            }
        }

        loadProfile();
    </script>
</body>
</html>